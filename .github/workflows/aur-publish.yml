# Publish to AUR after a release is created

name: Publish AUR Package

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.21)'
        required: true
        type: string

jobs:
  publish-aur-bin:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version }}
    steps:
      - uses: actions/checkout@v6

      - name: Download tarball from artifacts
        uses: actions/download-artifact@v7
        with:
          name: artifacts-x86_64-unknown-linux-gnu
          path: dist-artifacts/

      - name: Compute checksum
        id: checksum
        run: |
          SHA256=$(sha256sum dist-artifacts/fresh-editor-x86_64-unknown-linux-gnu.tar.xz | cut -d' ' -f1)
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "Computed SHA256: $SHA256"

      - name: Clone AUR repo and update PKGBUILD
        run: |
          git clone https://aur.archlinux.org/fresh-editor-bin.git aur-repo
          cd aur-repo
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          # Replace sha256sums array using awk (handles both single and multi-line formats safely)
          awk -v sha="${{ steps.checksum.outputs.sha256 }}" '
            /^sha256sums=\(.*\)$/ { print "sha256sums=(\"" sha "\" \"SKIP\")"; next }
            /^sha256sums=\(/ { in_sha=1; print "sha256sums=(\"" sha "\" \"SKIP\")"; next }
            in_sha && /\)[[:space:]]*$/ { in_sha=0; next }
            in_sha { next }
            { print }
          ' PKGBUILD > PKGBUILD.tmp && mv PKGBUILD.tmp PKGBUILD
          echo "Updated PKGBUILD:"
          cat PKGBUILD

      - name: Publish AUR package (fresh-editor-bin)
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: fresh-editor-bin
          pkgbuild: ./aur-repo/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${VERSION}"
          ssh_keyscan_types: ed25519

  publish-aur-source:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version }}
    steps:
      - uses: actions/checkout@v6

      - name: Download stable source tarball from release
        id: checksum
        run: |
          # Download the stable source tarball from the GitHub release (not the auto-generated archive)
          curl -sL "https://github.com/sinelaw/fresh/releases/download/v${VERSION}/fresh-editor-${VERSION}-source.tar.gz" -o source.tar.gz
          SHA256=$(sha256sum source.tar.gz | cut -d' ' -f1)
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "Computed SHA256: $SHA256"

      - name: Clone AUR repo and update PKGBUILD
        run: |
          git clone https://aur.archlinux.org/fresh-editor.git aur-repo
          cd aur-repo
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          # Update source URL to use stable release asset
          sed -i 's|^source=.*|source=("fresh-editor-${pkgver}-source.tar.gz::https://github.com/sinelaw/fresh/releases/download/v${pkgver}/fresh-editor-${pkgver}-source.tar.gz")|' PKGBUILD
          # Update sha256sums using awk for reliable replacement
          awk -v sha="${{ steps.checksum.outputs.sha256 }}" '
            /^sha256sums=\(.*\)$/ { print "sha256sums=(\"" sha "\")"; next }
            /^sha256sums=\(/ { in_sha=1; print "sha256sums=(\"" sha "\")"; next }
            in_sha && /\)[[:space:]]*$/ { in_sha=0; next }
            in_sha { next }
            { print }
          ' PKGBUILD > PKGBUILD.tmp && mv PKGBUILD.tmp PKGBUILD
          # Update paths for workspace restructuring (plugins/keymaps/themes moved to crates/fresh-editor/)
          sed -i 's|cp -r plugins |cp -r crates/fresh-editor/plugins |g' PKGBUILD
          sed -i 's|cp -r keymaps |cp -r crates/fresh-editor/keymaps |g' PKGBUILD
          sed -i 's|cp -r themes |cp -r crates/fresh-editor/themes |g' PKGBUILD
          echo "Updated PKGBUILD:"
          cat PKGBUILD

      - name: Publish AUR package (fresh-editor)
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: fresh-editor
          pkgbuild: ./aur-repo/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${VERSION}"
          ssh_keyscan_types: ed25519
